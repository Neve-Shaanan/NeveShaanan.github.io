import{A as S,D as pe,a as l,b,c as B,d as se,p as Ae,r as ne,s as Te,t as w,u as A,w as T,y as ae,z as Oe}from"https://st-p.rmcdn.net/8223b069/dist/c/c-YZUKAQBI.js";import{a as re,b as Re}from"https://st-p.rmcdn.net/8223b069/dist/c/c-JMI4WDJU.js";import{b as Q,c as Ve}from"https://st-p.rmcdn.net/8223b069/dist/c/c-AX5EGHSK.js";import{m as z,o as ee,t as Me}from"https://st-p.rmcdn.net/8223b069/dist/c/c-ZEVJDQYW.js";import{a as de,b as De}from"https://st-p.rmcdn.net/8223b069/dist/c/c-SOPFRTI2.js";import{a as I,b as oe}from"https://st-p.rmcdn.net/8223b069/dist/c/c-VIRZU2G3.js";import{c as R,k as te,o as ie}from"https://st-p.rmcdn.net/8223b069/dist/c/c-72NVQS7J.js";import{a as X}from"https://st-p.rmcdn.net/8223b069/dist/c/c-XVJOBTSH.js";import{A as L,h as K,i as Y,z as W}from"https://st-p.rmcdn.net/8223b069/dist/c/c-LXB6CLOG.js";import{h as G,m as J,n as f,o as M}from"https://st-p.rmcdn.net/8223b069/dist/c/c-4ZY5DMXY.js";import{b as $}from"https://st-p.rmcdn.net/8223b069/dist/c/c-FWG4ZALP.js";import{a as H,c as Ie,d as P,e as q}from"https://st-p.rmcdn.net/8223b069/dist/c/c-L5NKMJEA.js";import{a as m,d as N,f as n}from"https://st-p.rmcdn.net/8223b069/dist/c/c-LP3JJHSV.js";var ce=m(()=>{"use strict"});var le,ge=m(()=>{"use strict";ce();le=(g=21)=>crypto.getRandomValues(new Uint8Array(g)).reduce((c,e)=>(e&=63,e<36?c+=e.toString(36):e<62?c+=(e-26).toString(36).toUpperCase():e>62?c+="-":c+="_",c),"")});var v,C=m(()=>{"use strict";ge();b();ie();v=class extends l{constructor(){super();n(this,"triggersState",{});n(this,"triggersElements",{});this.initStore()}bindTriggerElement(e,t){this.setState(i=>({triggersElements:{...i.triggersElements,[e]:t}})),this.bindTriggerCallback(e)}bindTriggerCallback(e){let t=this.triggersState[e]||{},i=this.triggersElements[e];if(!i)return;let r=[];for(let o in t){let a=t[o];a&&(typeof a.unbind=="function"&&a.unbind(),a.unbind=te({element:i,events:a.events,callback:a.callback}),r.push(a.unbind))}return r}addTriggerCallback({responderWidgetId:e,triggerWidgetIds:t=[],events:i,callback:r}){let o=le(),a=[];for(let p of t){let s=`${e}-${o}`;p in this.triggersState||this.setState(d=>({triggersState:{...d.triggersState,[p]:{}}})),this.setState(d=>({triggersState:{...d.triggersState,[p]:{...d.triggersState[p],[s]:{events:i,callback:r}}}}));let u=this.bindTriggerCallback(p)||[];a.push(()=>{for(let d of u)typeof d=="function"&&d();delete this.triggersState[p][s]})}return()=>{for(let p of a)p()}}isWidgetTrigger(e){return e in this.triggersState}}});var y,F=m(()=>{"use strict";L();b();Ae();Re();y=class extends l{constructor(){super();n(this,"animations",{});n(this,"groupRects",{});n(this,"groupState",{});this.initStore()}getAnimationsGroups(e){let t={},i=K(Object.values(e).map(o=>o.animations).flat(),"UUID"),r=Object.entries(e);for(let[o,a]of r)for(let p of a.animations)i[p.UUID]>1&&(t[p.UUID]=[...t[p.UUID]||[],{widgetId:o,rect:a.rect}]);return t}getAnimationsGroupsRects(e){let t={},i=Object.keys(e);for(let r of i){let o=e[r].map(h=>{let We=this.animations[h.widgetId].transforms.rotation?.angle??0;return re.rotateBox(h.rect,We)}),a=Math.min(...o.map(h=>h.top)),p=Math.min(...o.map(h=>h.left)),s=Math.max(...o.map(h=>h.top+h.height)),d=Math.max(...o.map(h=>h.left+h.width))-p,V=s-a;t[r]={top:a,left:p,width:d,height:V}}return t}createGroupsState(e,t){let i={...e};for(let r in t){i[r]=i[r]||{};for(let o of t[r])o.widgetId in i[r]||(i[r][o.widgetId]=!1)}return i}addWidget({widgetId:e,animations:t,rect:i,rotation:r,flipY:o,flipX:a}){this.setState(p=>({animations:{...p.animations,[e]:{rect:i,animations:t,transforms:{flipX:a,flipY:o,rotation:B(r),invertedRotation:B((r||0)*-1)}}}})),this.recalculateRectsStates()}recalculateRectsStates(){let e=this.getAnimationsGroups(this.animations),t=this.getAnimationsGroupsRects(e),i=this.createGroupsState(this.groupState,e);this.setState({groupRects:t,groupState:i})}updateWidgetRect(e,t){this.setState(i=>({animations:{...i.animations,[e]:{...i.animations[e],rect:t}}})),this.recalculateRectsStates()}getAnimationsGroupRect(e){return e in this.groupRects?this.groupRects[e]:null}getAnimationsGroupOrigin(e,t){if(e in this.groupRects&&t in this.animations){let i=this.animations[t],r=i.transforms,o=i.rect,a=this.groupRects[e],p={x:o.left-a.left,y:o.top-a.top},s={x:a.width/2,y:a.height/2},u={x:s.x-p.x,y:s.y-p.y},d=se({rotation:r.invertedRotation,point:u,origin:{...o,left:0,top:0}});return r.flipX&&(d.x=o.width-d.x),r.flipY&&(d.y=o.height-d.y),d}return null}getGroupState(e){return e in this.groupState?Object.values(this.groupState[e]).some(Boolean):null}updateGroupState(e,t,i,r=!1){if(e in this.groupState)if(e in this.groupState||this.setState(o=>({groupState:{...o.groupState,[e]:{}}})),r)for(let o in this.groupState[e])this.setState(a=>({groupState:{...a.groupState,[e]:{[o]:i}}}));else this.setState(o=>({groupState:{...o.groupState,[e]:{[t]:i}}}))}getAnimationsWidgetRect(e){return this.animations[e]?.rect||null}}});var x,U=m(()=>{"use strict";b();x=class extends l{constructor(){super();n(this,"zIndexes",{});this.initStore()}init(e){for(let t of e)typeof t.model.z=="number"&&this.setZIndex(t.model._id,t.model.z),t.subscribe(i=>i.model.z,()=>{typeof t.model.z=="number"&&this.setZIndex(t.model._id,t.model.z)})}getTopmostZIndex(){return Math.max(...Object.values(this.zIndexes))}setZIndex(e,t){typeof t=="number"&&this.zIndexes[e]!==t&&this.setState(i=>({zIndexes:{...i.zIndexes,[e]:t}}))}}});var ke,O,ue=m(()=>{"use strict";b();M();q();T();T();ke={pageId:"",scale:1,zoom:1,transform:1,num:0,availableViewports:[],currentViewport:"default",hasTabletViewport:!1,hasPhoneViewport:!1,screenshot:"",desktopPageHeight:0,tabletPageHeight:0,phonePageHeight:0},O=class extends l{constructor(e){super();n(this,"projectViewport");n(this,"page");n(this,"state",ke);this.initStore(),this.page=e.page,this.setState({projectViewport:e.projectViewport.value}),e.projectViewport.subscribe(t=>t.value,t=>{this.setState({projectViewport:t}),this.computePageMeta()}),this.page.subscribe(t=>t.model,()=>{this.computePageMeta()}),this.computePageMeta()}computePageMeta(){let e=this.doesPageHasViewport("tablet_portrait"),t=this.doesPageHasViewport("phone_portrait"),i=["default",e&&"tablet_portrait",t&&"phone_portrait"].filter(Boolean);this.setState(r=>({state:{...r.state,pageId:this.page.model._id,num:this.page.model.num,uri:this.page.model.uri,seo:this.page.model.seo,customSeo:this.page.model.custom_shares,screenshot:this.page.model.screenshot,desktopPageHeight:A(this.page.model,"default"),tabletPageHeight:A(this.page.model,"tablet_portrait"),phonePageHeight:A(this.page.model,"phone_portrait"),currentViewport:this.getPageViewport(this.projectViewport),hasTabletViewport:e,hasPhoneViewport:t,availableViewports:i}}))}onScaleChange(e){this.setState(t=>({state:{...t.state,scale:e,zoom:P.isFirefox()?1:e,transform:P.isFirefox()?e:1}}))}getClosestViewport(e){let t=f.dictionary[e].width,i=f.viewports.reduce((r,o,a)=>{let p=w(o.name);if(p!=="viewport_default"){let s=this.page.model[p];if(!s||!s.enabled)return r}return Math.abs(o.width-t)<=Math.abs(f.viewports[r].width-t)?a:r},0);return f.viewports[i].name}doesPageHasViewport(e){let t=w(e);return t==="viewport_default"?!this.page.model.hidden:t in this.page.model&&!!this.page.model[t]?.enabled}getPageViewport(e){return!e||e==="default"||this.doesPageHasViewport(e)?e:this.getClosestViewport(e)}}});function He(g){return ee(g)?g.code.length>0:!0}var j,Mt,Rt,Z=m(()=>{"use strict";M();C();F();U();L();oe();b();pe();ue();Te();Me();ie();T();j=class extends l{constructor(e){super();n(this,"project");n(this,"triggersStore");n(this,"animationsStore");n(this,"zIndexStore");n(this,"model");n(this,"meta");n(this,"element");n(this,"widgets");this.initStore(),this.project=e.project,this.setState({triggersStore:new v,animationsStore:new y,zIndexStore:new x,element:new ne,model:e.page}),this.setState({meta:new O({page:this,projectViewport:e.project.projectViewport}),widgets:this.createWidgets(this.model.widgets)}),this.zIndexStore.init(Object.values(this.widgets).flat())}createWidgets(e=[]){let t={topFixed:[],backFixed:[],regular:[]};if(!e.length)return t;let i=s=>({...s,pid:this.model._id}),r=I(this.project.model.globalWidgets||[]).map(i),o=I(e).map(i),a=W([...o,...r],s=>s._id),p=this.getWidgetsRenderList(a);p.background&&(t.background=this.createWidget(p.background));for(let s of p.topFixed)t.topFixed.push(this.createWidget(s));for(let s of p.backFixed)t.backFixed.push(this.createWidget(s));for(let s of p.regular)t.regular.push(this.createWidget(s));return t}createWidget(e){return new S({pageMeta:this.meta,project:this.project,triggersStore:this.triggersStore,animationsStore:this.animationsStore,zIndexStore:this.zIndexStore,widget:e})}setWidgets(e){this.setState(t=>({model:{...t.model,widgets:e},widgets:this.createWidgets(e)})),this.zIndexStore.init(Object.values(this.widgets).flat())}getWidgetsRenderList(e=[]){if(!e||!e.length)return{regular:[],topFixed:[],backFixed:[]};let t,i=[],r=[],o=[],a=G.reduce((s,u)=>(s[u]=1/0,s),{}),p=G.filter(s=>this.isViewportEnabled(s));for(let s of e)if(He(s))if(z(s))t=s;else{if(s.is_above)continue;for(let u of p){let d=S.getWidgetViewportData(s,u,this.model._id);d&&(d.fixed_position||(i.push(s),a[u]=Math.min(a[u],d.z)))}}for(let s of p)a[s]===1/0&&(a[s]=0);for(let s of e)if(!(z(s)||s.is_above))for(let u of p){let d=S.getWidgetViewportData(s,u,this.model._id);!d||!d.fixed_position||(d.z<a[u]?o.push(s):r.push(s))}return i=W(i,s=>s._id),o=W(o,s=>s._id),r=W(r,s=>s._id),{background:t,regular:R(i),topFixed:R(r),backFixed:R(o)}}isViewportEnabled(e){let t=w(e);return t==="viewport_default"?!0:this.model[t]?.enabled}},{useStore:Mt,Provider:Rt}=l.createContext()});var D,me=m(()=>{"use strict";M();L();b();Ie();q();D=class extends l{constructor(){super();n(this,"value","default");this.initStore(),this.setState({value:this.getProjectViewport()}),this.bindEvents()}bindEvents(){if(H())return;let e=Y(this.refreshProjectViewport,40);window.addEventListener("resize",e),window.addEventListener("orientationchange",e)}refreshProjectViewport(){this.setState({value:this.getProjectViewport()})}getProjectViewport(){if(H())return"default";let e=window.innerWidth,t=P.isPortrait();if(P.isIpad())return t?"tablet_portrait":"default";if(window.devicePixelRatio>1||P.isMobile()||P.isTouch()){if(t)return e<=599?"phone_portrait":e>=600&&e<=1024?"tablet_portrait":"default";if(e>980)return"default";let i=f.viewports.reduce((r,o,a)=>Math.abs(o.width-e)<=Math.abs(f.viewports[r].width-e)?a:r,0);return f.viewports[i].name}return"default"}}});var Ge,_,he=m(()=>{"use strict";$();b();T();Ge={viewertype:"vertical"},_=class extends l{constructor(e){super();n(this,"projectViewport");n(this,"_state");n(this,"state");this.initStore(),this.setState({projectViewport:e.project.projectViewport.value}),e.project.projectViewport.subscribe(t=>t.value,t=>{this.setState({projectViewport:t}),this.computeOptions()}),this._state={options:{...Ge,...e.project.model.opts||{}},viewport_phone_portrait:{options:e.project.model.viewport_phone_portrait?.opts||{}},viewport_tablet_portrait:{options:e.project.model.viewport_phone_portrait?.opts||{}}},this.setState({state:this._state.options}),this.computeOptions()}getOverrides(e){return e!=="viewport_default"?this._state[e]?.options:{}}computeOptions(){this.setState({state:this.getOptionsForViewport(this.projectViewport)})}setOptions(e){let t=w(this.projectViewport);if(t==="viewport_default"){let i={...this._state.options,...e};this._state.options=i}else{let r={...this.getOverrides(t),...e},o={...this._state.options,...r};this._state[t].options=o}this.computeOptions(),window.dispatchEvent(new Event("resize"))}getOptionsForViewport(e){let t=w(e),i=this.getOverrides(t);return{...this._state.options,...i}}}});function be(g){let c=null;function e(r){return c||(c=new de(g),Q("scroll",c)),c?.addListener(r),()=>{c?.removeListener(r)}}function t(r,o=[]){(0,fe.useEffect)(()=>{let a=e(r);return()=>{a()}},o)}function i(){c?.destroy()}return{useScrollPosition:t,destroyScroll:i,scrollSubscribe:e}}var fe,Pe=m(()=>{"use strict";fe=N(X());De();Ve()});var Xt,Jt,we,Se=m(()=>{"use strict";Pe();({useScrollPosition:Xt,destroyScroll:Jt,scrollSubscribe:we}=be())});var ve,E,ye=m(()=>{"use strict";ve=N(X());$();M();pe();Oe();Se();E=class extends S{constructor(e){super(e);n(this,"viewertype");n(this,"project");n(this,"currentPageId");n(this,"nextAdjacentPageId");n(this,"nextPageData",null);this.currentPageId=e.initialPageId,this.project=e.project,this.viewertype=this.project.options.state.viewertype,this.project.options.subscribe(t=>t.state.viewertype,t=>{this.viewertype=t}),this.setCurrentPage(e.initialPageId),this.bindScrollListener()}setCurrentPage(e){(0,ve.startTransition)(()=>{this._model.pid!==e&&(J(this._model,t=>{t&&(t.pid=e,Object.assign(t,ae(t,e)))}),this.computeWidgetModel())})}bindRouter(e){e.subscribe(t=>({currentPageId:t.state.currentPageId,nextAdjacentPageId:t.state.nextAdjacentPageId}),()=>{this.setCurrentPage(e.state.currentPageId),this.currentPageId=e.state.currentPageId,this.nextAdjacentPageId=e.state.nextAdjacentPageId;let t=this.nextAdjacentPageId?this.project.findPageById(this.nextAdjacentPageId):void 0;t&&(this.nextPageData={pageScale:t.meta.state.scale,offsetTop:t.element.offset.top})},!0)}bindScrollListener(){this.viewertype==="vertical"&&we(this.handleAboveWidgetsScroll)}handleAboveWidgetsScroll(e){if(!this.nextPageData){this.handleVisibility(!1,!1);return}let t=this.element.rect.height,i=this.element.offset.top,r=this.nextPageData.pageScale,o=t*r,a=i*r,p=this.nextPageData.offsetTop,s=e.scrollTop,u=p-s<a+o,d=p-s<a,V=!this.handleVisibility(u,d);V!==this.visibility.isVisible&&this.setState({visibility:{...this.visibility,isVisible:V}})}handleVisibility(e,t){return this.nextAdjacentPageId?(this.isAboveWidgetHidden(this.currentPageId)||e&&this.isAboveWidgetHidden(this.nextAdjacentPageId))&&!(t&&!this.isAboveWidgetHidden(this.nextAdjacentPageId)):this.isAboveWidgetHidden(this.currentPageId)}isAboveWidgetHidden(e){let t=this.model.hidden,i=this.model._hidden;if(i&&Array.isArray(i)){let r=i.find(o=>o.pid===e)||i.find(o=>o.pid==="default");if(r&&typeof r.value=="boolean")return r.value}return!!t}}});var k,xe=m(()=>{"use strict";Z();C();F();U();ye();b();k=class extends l{constructor(e){super();n(this,"project");n(this,"triggersStore");n(this,"animationsStore");n(this,"zIndexStore");n(this,"aboveWidgets");n(this,"abovePage");this.initStore(),this.project=e.project,this.setState({triggersStore:new v,animationsStore:new y,zIndexStore:new x}),this.setState({abovePage:new j({page:{_id:"above-page",num:-1,num_id:-1,height:0},project:this.project}),aboveWidgets:this.createAboveAllWidgets(e.aboveAllWidgets,e.initialPageId)}),this.zIndexStore.init(this.aboveWidgets)}createAboveAllWidgets(e=[],t){let i=[];for(let r of e)i.push(new E({widget:r,initialPageId:t,pageMeta:void 0,project:this.project,triggersStore:this.triggersStore,animationsStore:this.animationsStore,zIndexStore:this.zIndexStore}));return i}bindAboveWidgetsRouter(e){for(let t of this.aboveWidgets)t.bindRouter(e)}}});var je,yi,xi,ze=m(()=>{"use strict";oe();b();Z();me();he();xe();je=class extends l{constructor(e){super();n(this,"model");n(this,"pages",[]);n(this,"projectViewport");n(this,"options");n(this,"meta");n(this,"abovePage");this.initStore(),this.setState({model:e.project,projectViewport:new D}),this.setState({options:new _({project:this})}),this.setState({meta:{num_id:this.model.num_id,title:this.model.title||"",description:this.model.title||"",masterSharePageId:this.model.master_share_pid||"",editParams:this.model.edit_params||{},owner:this.model.user,forbiddenBackground:this.model.pass_bg,publicPath:e.publicPath,isExportedProject:e.isExportedProject||!1,isProjectOnDomain:e.isProjectOnDomain||!1,isProjectOnProfileDomain:e.isProjectOnProfileDomain||!1,exportedBasePath:e.exportedBasePath||""},pages:this.createPages(this.model.pages||[]),abovePage:new k({aboveAllWidgets:this.model.aboveAllWidgets,initialPageId:e.initialPageId||this.findPageByIndex("first")?.model._id||"",project:this})})}createPages(e){let t=[];for(let i of e)t.push(new j({project:this,page:I(i)}));return t}findPageByIndex(e){let t=typeof e=="number"?e:e==="first"?0:this.pages.length-1,i=this.pages[t];if(i)return i}findPageById(e){return this.pages.find(t=>t.model._id===e)}findPageByUri(e){return this.pages.find(t=>t.model.uri===e)}findPageByNum(e){return this.pages.find(t=>t.model.num===e)}getPageIndex(e){let t=this.pages.findIndex(i=>i.model._id===e);return t===-1?null:t}getPageUri(e){let t=this.findPageById(e);return t?t.model.uri?`${t.model.uri}/`:t.model.num===1?"":`${t.model.num}/`:null}getPageNum(e){let t=this.findPageById(e);return t?t.model.num:null}getFirstPage(){return this.pages[0]}getLastPage(){return this.pages[this.pages.length-1]}},{useStore:yi,Provider:xi}=l.createContext()});export{Mt as a,Rt as b,Z as c,Xt as d,Se as e,je as f,yi as g,xi as h,ze as i};
