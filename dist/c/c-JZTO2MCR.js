import{A as oe,a as z,b as te,n as be,p as ie,q as we,r as w,s as A,u as F,v as re,w as ve,x as v}from"https://st-p.rmcdn.net/af2666fc/dist/c/c-CBX42T2H.js";import{c as d,d as P}from"https://st-p.rmcdn.net/af2666fc/dist/c/c-JWGHTXKT.js";import{a as Q,b as fe}from"https://st-p.rmcdn.net/af2666fc/dist/c/c-QEHHZFGW.js";import{a as ee,b as Pe}from"https://st-p.rmcdn.net/af2666fc/dist/c/c-OO3DAJVF.js";import{m as G,o as X,s as he}from"https://st-p.rmcdn.net/af2666fc/dist/c/c-J3BGDRJM.js";import{c as R,k as Y,o as J}from"https://st-p.rmcdn.net/af2666fc/dist/c/c-72MKFQGT.js";import{l as M,m as K}from"https://st-p.rmcdn.net/af2666fc/dist/c/c-UDEESYNX.js";import{g as N,h as q,y as V,z as C}from"https://st-p.rmcdn.net/af2666fc/dist/c/c-U334KKIN.js";import{h as W,m as $,n as f,o as I}from"https://st-p.rmcdn.net/af2666fc/dist/c/c-55VYORUF.js";import{b as ue}from"https://st-p.rmcdn.net/af2666fc/dist/c/c-UB3G6XPO.js";import{a as D,c as me,d as b,e as Z}from"https://st-p.rmcdn.net/af2666fc/dist/c/c-E3FYFF3U.js";import{a as h,f as s}from"https://st-p.rmcdn.net/af2666fc/dist/c/c-UGUCNLQ2.js";var y,B=h(()=>{"use strict";Pe();P();J();y=class extends d{constructor(){super();s(this,"triggersState",{});s(this,"triggersElements",{})}bindTriggerElement(e,t){this.triggersElements[e]=this.detach(t),this.bindTriggerCallback(e)}bindTriggerCallback(e){let t=this.triggersState[e]||{},i=this.triggersElements[e];if(!i)return;let o=[];for(let n in t){let a=t[n];a&&(typeof a.unbind=="function"&&a.unbind(),a.unbind=Y({element:i,events:a.events,callback:a.callback}),o.push(a.unbind))}return o}addTriggerCallback({responderWidgetId:e,triggerWidgetIds:t=[],events:i,callback:o}){let n=ee(),a=[];for(let r of t){let p=`${e}-${n}`;r in this.triggersState||(this.triggersState[r]={}),this.triggersState[r][p]={events:i,callback:o};let l=this.bindTriggerCallback(r)||[];a.push(()=>{for(let u of l)typeof u=="function"&&u();delete this.triggersState[r][p]})}return()=>{for(let r of a)r()}}isWidgetTrigger(e){return e in this.triggersState}}});var x,L=h(()=>{"use strict";C();P();be();fe();x=class extends d{constructor(){super();s(this,"animations",{});s(this,"groupRects",{});s(this,"groupState",{})}getAnimationsGroups(e){let t={},i=N(Object.values(e).map(n=>n.animations).flat(),"UUID"),o=Object.entries(e);for(let[n,a]of o)for(let r of a.animations)i[r.UUID]>1&&(t[r.UUID]=[...t[r.UUID]||[],{widgetId:n,rect:a.rect}]);return t}getAnimationsGroupsRects(e){let t={},i=Object.keys(e);for(let o of i){let n=e[o].map(m=>{let le=this.animations[m.widgetId].transforms.rotation?.angle??0;return Q.rotateBox(m.rect,le)}),a=Math.min(...n.map(m=>m.top)),r=Math.min(...n.map(m=>m.left)),p=Math.max(...n.map(m=>m.top+m.height)),u=Math.max(...n.map(m=>m.left+m.width))-r,ce=p-a;t[o]={top:a,left:r,width:u,height:ce}}return t}createGroupsState(e,t){let i={...e};for(let o in t){i[o]=i[o]||{};for(let n of t[o])n.widgetId in i[o]||(i[o][n.widgetId]=!1)}return i}addWidget({widgetId:e,animations:t,rect:i,rotation:o,flipY:n,flipX:a}){this.animations[e]={rect:i,animations:t,transforms:{flipX:a,flipY:n,rotation:z(o),invertedRotation:z((o||0)*-1)}},this.recalculateRectsStates()}recalculateRectsStates(){let e=this.getAnimationsGroups(this.animations),t=this.getAnimationsGroupsRects(e),i=this.createGroupsState(this.groupState,e);this.groupRects=t,this.groupState=i}updateWidgetRect(e,t){this.animations[e].rect=t,this.recalculateRectsStates()}getAnimationsGroupRect(e){return e in this.groupRects?this.groupRects[e]:null}getAnimationsGroupOrigin(e,t){if(e in this.groupRects&&t in this.animations){let i=this.animations[t],o=i.transforms,n=i.rect,a=this.groupRects[e],r={x:n.left-a.left,y:n.top-a.top},p={x:a.width/2,y:a.height/2},l={x:p.x-r.x,y:p.y-r.y},u=te({rotation:o.invertedRotation,point:l,origin:{...n,left:0,top:0}});return o.flipX&&(u.x=n.width-u.x),o.flipY&&(u.y=n.height-u.y),u}return null}getGroupState(e){return e in this.groupState?Object.values(this.groupState[e]).some(Boolean):null}updateGroupState(e,t,i,o=!1){if(e in this.groupState)if(this.groupState[e]=this.groupState[e]||{},o)for(let n in this.groupState[e])this.groupState[e][n]=i;else this.groupState[e][t]=i}getAnimationsWidgetRect(e){return this.animations[e]?.rect||null}}});var j,H=h(()=>{"use strict";P();j=class extends d{constructor(){super();s(this,"zIndexes",{})}init(e){for(let t of e)typeof t.model.z=="number"&&this.setZIndex(t.model._id,t.model.z),t.subscribe("model.z",()=>{typeof t.model.z=="number"&&this.setZIndex(t.model._id,t.model.z)})}getTopmostZIndex(){return Math.max(...Object.values(this.zIndexes))}setZIndex(e,t){typeof t=="number"&&this.zIndexes[e]!==t&&(this.zIndexes[e]=t)}}});var je,O,se=h(()=>{"use strict";P();I();Z();F();F();je={pageId:"",scale:1,zoom:1,transform:1,num:0,availableViewports:[],currentViewport:"default",hasTabletViewport:!1,hasPhoneViewport:!1,screenshot:"",desktopPageHeight:0,tabletPageHeight:0,phonePageHeight:0},O=class extends d{constructor(e){super();s(this,"projectViewport");s(this,"page");s(this,"state",je);this.page=e.page,this.projectViewport=e.projectViewport.value,e.projectViewport.subscribe("value",t=>{this.projectViewport=t,this.computePageMeta()}),this.page.subscribe("model",()=>{this.computePageMeta()}),this.computePageMeta()}computePageMeta(){let e=this.doesPageHasViewport("tablet_portrait"),t=this.doesPageHasViewport("phone_portrait"),i=["default",e&&"tablet_portrait",t&&"phone_portrait"].filter(Boolean);this.state={...this.state,pageId:this.page.model._id,num:this.page.model.num,uri:this.page.model.uri,seo:this.page.model.seo,customSeo:this.page.model.custom_shares,screenshot:this.page.model.screenshot,desktopPageHeight:A(this.page.model,"default"),tabletPageHeight:A(this.page.model,"tablet_portrait"),phonePageHeight:A(this.page.model,"phone_portrait"),currentViewport:this.getPageViewport(this.projectViewport),hasTabletViewport:e,hasPhoneViewport:t,availableViewports:i}}onScaleChange(e){this.state.scale=e,this.state.zoom=b.isFirefox()?1:e,this.state.transform=b.isFirefox()?e:1}getClosestViewport(e){let t=f.dictionary[e].width,i=f.viewports.reduce((o,n,a)=>{let r=w(n.name);if(r!=="viewport_default"){let p=this.page.model[r];if(!p||!p.enabled)return o}return Math.abs(n.width-t)<=Math.abs(f.viewports[o].width-t)?a:o},0);return f.viewports[i].name}doesPageHasViewport(e){let t=w(e);return t==="viewport_default"?!this.page.model.hidden:t in this.page.model&&!!this.page.model[t]?.enabled}getPageViewport(e){return!e||e==="default"||this.doesPageHasViewport(e)?e:this.getClosestViewport(e)}}});function Se(c){return X(c)?c.code.length>0:!0}var S,dt,gt,ct,U=h(()=>{"use strict";I();B();L();H();C();K();P();oe();se();we();he();J();S=class extends d{constructor(e){super();s(this,"project");s(this,"triggersStore");s(this,"animationsStore");s(this,"zIndexStore");s(this,"model");s(this,"meta");s(this,"element");s(this,"widgets");this.project=e.project,this.triggersStore=this.detach(new y),this.animationsStore=this.detach(new x),this.zIndexStore=this.detach(new j),this.model=e.page,this.element=this.detach(new ie),this.meta=new O({page:this,projectViewport:e.project.projectViewport}),this.widgets=this.createWidgets(this.model.widgets),this.zIndexStore.init(Object.values(this.widgets).flat())}createWidgets(e=[]){let t=p=>({...p,pid:this.model._id}),i=M(this.project.model.globalWidgets||[]).map(t),o=M(e).map(t),n=V([...o,...i],p=>p._id),a=this.getWidgetsRenderList(n),r={topFixed:[],backFixed:[],regular:[]};a.background&&(r.background=this.createWidget(a.background));for(let p of a.topFixed)r.topFixed.push(this.createWidget(p));for(let p of a.backFixed)r.backFixed.push(this.createWidget(p));for(let p of a.regular)r.regular.push(this.createWidget(p));return r}createWidget(e){return this.detach(new v({pageMeta:this.meta,project:this.project,triggersStore:this.triggersStore,animationsStore:this.animationsStore,zIndexStore:this.zIndexStore,widget:e}))}setWidgets(e){this.model.widgets=e,this.widgets=this.createWidgets(e),this.zIndexStore.init(Object.values(this.widgets).flat())}getWidgetsRenderList(e=[]){if(!e||!e.length)return{regular:[],topFixed:[],backFixed:[]};let t,i=[],o=[],n=[],a=W.reduce((r,p)=>(r[p]=1/0,r),{});for(let r of e)if(Se(r))if(G(r))t=r;else{if(r.is_above)continue;for(let p of W){let l=v.getWidgetViewportData(r,p,this.model._id);l&&(l.fixed_position||(i.push(r),a[p]=Math.min(a[p],l.z)))}}for(let r of W)a[r]===1/0&&(a[r]=0);for(let r of e)if(!(G(r)||r.is_above))for(let p of W){let l=v.getWidgetViewportData(r,p,this.model._id);!l||!l.fixed_position||(l.z<a[p]?n.push(r):o.push(r))}return i=V(i,r=>r._id),n=V(n,r=>r._id),o=V(o,r=>r._id),{background:t,regular:R(i),topFixed:R(o),backFixed:R(n)}}},{useSnapshot:dt,useProxy:gt,Provider:ct}=d.createContext()});var T,ne=h(()=>{"use strict";I();C();P();me();Z();T=class extends d{constructor(){super();s(this,"value");this.value=this.getProjectViewport(),this.bindEvents()}bindEvents(){if(D())return;let e=q(this.refreshProjectViewport,40);window.addEventListener("resize",e),window.addEventListener("orientationchange",e)}refreshProjectViewport(){this.value=this.getProjectViewport()}getProjectViewport(){if(D())return"default";let e=window.innerWidth,t=b.isPortrait();if(b.isIpad())return t?"tablet_portrait":"default";if(window.devicePixelRatio>1||b.isMobile()||b.isTouch()){if(t)return e<=599?"phone_portrait":e>=600&&e<=1024?"tablet_portrait":"default";if(e>980)return"default";let i=f.viewports.reduce((o,n,a)=>Math.abs(n.width-e)<=Math.abs(f.viewports[o].width-e)?a:o,0);return f.viewports[i].name}return"default"}}});var Ve,_,ae=h(()=>{"use strict";I();ue();P();F();Ve={viewertype:"vertical"},_=class extends d{constructor(e){super();s(this,"projectViewport");s(this,"_state");s(this,"state");this.projectViewport=e.project.projectViewport.value,e.project.projectViewport.subscribe("value",t=>{this.projectViewport=t,this.computeOptions()}),this._state={options:{...Ve,...e.project.model.opts||{}},viewport_phone_portrait:{options:e.project.model.viewport_phone_portrait?.opts||{}},viewport_tablet_portrait:{options:e.project.model.viewport_phone_portrait?.opts||{}}},this.state=this._state.options,this.computeOptions()}getOverrides(e){return e!=="viewport_default"?this._state[e]?.options:{}}computeOptions(){this.state=this.getOptionsForViewport(this.projectViewport)}setOptions(e){let t=w(this.projectViewport);if(t==="viewport_default"){let i={...this._state.options,...e};this._state.options=i}else{let o={...this.getOverrides(t),...e},n={...this._state.options,...o};this._state[t].options=n}this.computeOptions(),window.dispatchEvent(new Event("resize"))}getOptionsForViewport(e){let t=w(e),i=this.getOverrides(t);return{...this._state.options,...i}}}});var k,pe=h(()=>{"use strict";I();oe();ve();k=class extends v{constructor(g){super(g),this.setCurrentPage(g.initialPageId)}setCurrentPage(g){this._model.pid!==g&&($(this._model,e=>{e&&(e.pid=g,Object.assign(e,re(e,g)))}),this.computeWidgetModel())}bindRouter(g){g.subscribe("state.currentPageId",()=>{this.setCurrentPage(g.state.currentPageId)})}}});var E,de=h(()=>{"use strict";U();B();L();H();pe();P();E=class extends d{constructor(e){super();s(this,"project");s(this,"triggersStore");s(this,"animationsStore");s(this,"zIndexStore");s(this,"aboveWidgets");s(this,"abovePage");this.project=e.project,this.abovePage=new S({page:{_id:"above-page",num:-1,num_id:-1,height:0},project:this.project}),this.triggersStore=this.detach(new y),this.animationsStore=this.detach(new x),this.zIndexStore=this.detach(new j),this.aboveWidgets=this.createAboveAllWidgets(e.aboveAllWidgets,e.initialPageId),this.zIndexStore.init(this.aboveWidgets)}createAboveAllWidgets(e=[],t){let i=[];for(let o of e)i.push(new k({widget:o,initialPageId:t,pageMeta:void 0,project:this.project,triggersStore:this.triggersStore,animationsStore:this.animationsStore,zIndexStore:this.zIndexStore}));return i}bindAboveWidgetsRouter(e){for(let t of this.aboveWidgets)t.bindRouter(e)}}});var ge,Kt,Xt,Yt,We=h(()=>{"use strict";K();P();U();ne();ae();de();ge=class extends d{constructor(e){super();s(this,"model");s(this,"pages",[]);s(this,"projectViewport");s(this,"options");s(this,"meta");s(this,"abovePage");this.model=e.project,this.projectViewport=new T,this.options=new _({project:this}),this.meta={num_id:this.model.num_id,title:this.model.title||"",description:this.model.title||"",masterSharePageId:this.model.master_share_pid||"",editParams:this.model.edit_params||{},owner:this.model.user,forbiddenBackground:this.model.pass_bg,publicPath:e.publicPath,isExportedProject:e.isExportedProject||!1,isProjectOnDomain:e.isProjectOnDomain||!1,isProjectOnProfileDomain:e.isProjectOnProfileDomain||!1,exportedBasePath:e.exportedBasePath||""},this.pages=this.createPages(this.model.pages||[]),this.abovePage=this.detach(new E({aboveAllWidgets:this.model.aboveAllWidgets,initialPageId:e.initialPageId||this.findPageByIndex("first")?.model._id||"",project:this}))}createPages(e){let t=[];for(let i of e)t.push(this.detach(new S({project:this,page:M(i)})));return t}findPageByIndex(e){let t=typeof e=="number"?e:e==="first"?0:this.pages.length-1,i=this.pages[t];if(i)return i}findPageById(e){return this.pages.find(t=>t.model._id===e)}findPageByUri(e){return this.pages.find(t=>t.model.uri===e)}findPageByNum(e){return this.pages.find(t=>t.model.num===e)}getPageIndex(e){let t=this.pages.findIndex(i=>i.model._id===e);return t===-1?null:t}getPageUri(e){let t=this.findPageById(e);return t?t.model.uri?`${t.model.uri}/`:t.model.num===1?"":`${t.model.num}/`:null}getPageNum(e){let t=this.findPageById(e);return t?t.model.num:null}},{useSnapshot:Kt,useProxy:Xt,Provider:Yt}=d.createContext()});export{dt as a,ct as b,U as c,ge as d,Kt as e,Xt as f,Yt as g,We as h};
